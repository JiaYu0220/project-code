import{s as o,a as d}from"./main-56a0edac.js";import{R as L,a as u,s as S,h as c,b as V,G as q,p as E}from"./login-73f62d5b.js";function C(e){e.classList.remove("is-valid"),e.classList.add("is-invalid")}function m(e){e.classList.remove("is-invalid"),e.classList.add("is-valid")}let n={email:"",password:"",phone:"",name:"",role:"學生",title:"",avatar:"https://raw.githubusercontent.com/Peg-L/project-code/0a1e1a3dcd659bc9a4c72332f12ef660630a103e/assets/images/logo-img.svg",birthdate:"",gender:"",address:"",followList:[]};function k(e){const t=e.target.form;n={email:t.Email.value,password:t.密碼.value,phone:t.手機.value,name:t.姓名.value,role:"學生",title:"",avatar:t.頭像?t.頭像.value:"https://raw.githubusercontent.com/Peg-L/project-code/0a1e1a3dcd659bc9a4c72332f12ef660630a103e/assets/images/logo-img.svg",birthdate:"",gender:"",address:"",followList:[]}}const l=document.querySelector("#registerBtn"),v=/^09\d{8}$/,j=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/,x=/^\d{6}$/,$={Email:{presence:{message:"Email 為必填"},email:{message:"Email 格式不符"}},密碼:{presence:{message:"密碼為必填"},format:{pattern:j,message:"密碼格式不符"}},確認密碼:{presence:{message:"確認密碼為必填"},equality:{attribute:"密碼",message:"確認密碼與密碼不符"}},手機:{presence:{message:"手機為必填"},format:{pattern:v,message:"手機格式不符"}},驗證碼:{presence:{message:"驗證碼為必填"},format:{pattern:x,message:"驗證碼格式不符"}},姓名:{presence:{message:"姓名為必填"}}},D=document.querySelector("#registerForm"),P=document.querySelectorAll("input[type=email], input[type=text], input[type=tel], input[type=password]");function R(){P.forEach(e=>{e.addEventListener("change",function(){const t=e.name;document.querySelector(`p[data-message="${t}"]`).textContent="";let s=validate(D,$,{fullMessages:!1});s?(document.querySelector(`[data-message="${t}"]`).textContent=s[t],l.setAttribute("disabled","true"),s[t]?C(e):m(e)):(m(e),l.removeAttribute("disabled"));const a=document.querySelector('[name="手機"]');v.test(a.value)?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled")})})}R();const y=document.querySelector("#inputVerifyCode");window.recaptchaVerifier=new L(u,"verify-button",{size:"invisible",callback:e=>{}});function A(){return document.querySelector("#floatingTel").value}let p;const r=document.querySelector("#sendCode"),f=document.querySelector("#sendCodeSpinner"),F=window.recaptchaVerifier;r.addEventListener("click",function(){f.classList.remove("d-none"),p="+886"+A(),S(u,p,F).then(t=>{y.classList.remove("d-none"),f.classList.add("d-none"),window.confirmationResult=t}).catch(t=>{o("發生錯誤，請稍後再試"),t=="FirebaseError: Firebase: Invalid format. (auth/invalid-phone-number)."&&alert("手機格式不符，請重新輸入"),grecaptcha.reset(window.recaptchaWidgetId),window.recaptchaVerifier.render().then(function(s){grecaptcha.reset(s)})})});function N(){return document.querySelector("#floatingVerifyCode").value}let g;const I=document.querySelector("#verify-button"),T=document.querySelector("#verifySuccessMsg");I.addEventListener("click",function(){g=N(),confirmationResult.confirm(g).then(e=>{e.user,y.classList.add("d-none"),T.classList.remove("d-none"),r.classList.add("d-none")}).catch(e=>{o("發生錯誤，請稍後再試")})});l.addEventListener("click",function(e){e.preventDefault(),k(e),b(n,!1)});function M(e){let t=e.match(/^(.)(.*)(.)@(.+)$/);return t[1]+"******"+t[3]+"@"+t[4]}async function U(e){try{const t={headers:{"Content-Type":"application/json"}};let s=Date.now(),a=new Date(s);a.setDate(a.getDate()+30),a.setHours(23,59,59,999);const i={userId:e,couponId:1,canUse:!0,timestamp:s,dueDate:a},w={userId:e,purchased:[],attendTime:[]};await Promise.all([d.post("https://project-code-json.onrender.com/myCoupons",i,t),d.post("https://project-code-json.onrender.com/user_courses",w,t)])}catch{o("發生錯誤，請稍後再試")}}function b(e,t){d.post("https://project-code-json.onrender.com/users",e).then(s=>{let a=M(e.email);const i=document.querySelector("#emailVerified");i.innerHTML=`<p class="mb-4">
我們已寄送一封帳號驗證信至您的信箱
<br />
${a}
</p>
<p class="mb-10">
請點擊驗證信的「<strong>連結</strong>」來開通帳號
</p>
<div
class="text-center mb-2 d-flex justify-content-between align-items-center"
>
<span>沒收到信嗎?</span>
<button
  type="button"
  class="btn btn-outline-secondary2 rounded-1 py-2"
>
  重新寄送驗證信
</button>
</div>`,U(s.data.user.id),t?c(e,!0):c(e,!1)}).catch(s=>{s.response.data=="Email already exists"&&(t?c(e,!0):Swal.fire({icon:"error",title:"此帳號已註冊",text:"請前往登入頁面或註冊新帳號"}))})}const h=document.querySelector("#google-register");h&&h.addEventListener("click",function(){V(u,E).then(e=>{q.credentialFromResult(e).accessToken;const s=e.user;n.email=s.email,n.password="00000000",n.name=s.displayName,n.phone=s.phoneNumber,n.avatar=s.photoURL,b(n,!0)}).catch(e=>{o("發生錯誤，請稍後再試")})});
